<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>

<body>

    <h1>加速度データ</h1>
    <button onclick="requestMotionPermission();">許可を得てセンシングを開始</button>
    <button onclick="stopDeviceMotion();">停止</button>

    <h2>加速度</h2>
    <p> X: <span id="accel-x">0</span> </p>
    <p> Y: <span id="accel-y">0</span> </p>
    <p> Z: <span id="accel-z">0</span> </p>

    <h3>加速度統計 (リアルタイムバッファ)</h3>
    <p>X - 最大値: <span id="accel-x-max">0</span>, 最小値: <span id="accel-x-min">0</span>, 平均: <span id="accel-x-avg">0</span>, 分散: <span id="accel-x-var">0</span></p>
    <p>Y - 最大値: <span id="accel-y-max">0</span>, 最小値: <span id="accel-y-min">0</span>, 平均: <span id="accel-y-avg">0</span>, 分散: <span id="accel-y-var">0</span></p>
    <p>Z - 最大値: <span id="accel-z-max">0</span>, 最小値: <span id="accel-z-min">0</span>, 平均: <span id="accel-z-avg">0</span>, 分散: <span id="accel-z-var">0</span></p>

    <h2>合計加速度</h2>
    <p> 合計加速度: <span id="accel-total">0</span> </p>
    <h3>合計加速度統計 (リアルタイムバッファ)</h3>
    <p>合計 - 最大値: <span id="accel-total-max">0</span>, 最小値: <span id="accel-total-min">0</span>, 平均: <span id="accel-total-avg">0</span>, 分散: <span id="accel-total-var">0</span></p>

    <h2>分類結果</h2>
    <p>現在の活動: <span id="classification-result">null</span></p>

    <h2>加速度のCSVデータ</h2>
    <textarea id="acc-csv" style="width:300px;height:300px;"></textarea><br>
    <button onclick="downloadCSV('accel_data.csv', 'acc-csv');">CSVダウンロード</button>

<script type="text/javascript">
alert("サンプルページ4へようこそ！");

const ACCEL_BUFFER_SIZE = 50;
let accelXBuffer = [];
let accelYBuffer = [];
let accelZBuffer = [];
let accelTotalBuffer = [];

function requestMotionPermission(){
    if ( DeviceMotionEvent &&
          typeof DeviceMotionEvent.requestPermission === 'function' ){
        DeviceMotionEvent.requestPermission().then(permissionState => {
            if (permissionState === 'granted') {
                window.addEventListener("devicemotion", handleAcceleration, false);
                resetUIAndBuffers();
            } else {
                console.log("許可が得られませんでした！");
                alert("許可が得られませんでした！");
            }
        }).catch(console.error)
    } else {
        console.log("その他のデバイスを検出しました。リスナーを追加します...");
        window.addEventListener("devicemotion", handleAcceleration, false);
        resetUIAndBuffers();
    }
}

function stopDeviceMotion(){
    window.removeEventListener("devicemotion", handleAcceleration, false);
    console.log("センシングを停止しました。");
}

function resetUIAndBuffers() {
    accelXBuffer = [];
    accelYBuffer = [];
    accelZBuffer = [];
    accelTotalBuffer = [];
    $('#acc-csv').val('timestamp,type,x,y,z,total_accel,predicted_activity\n');
    $('#classification-result').text('null');
    $('#accel-x-max').text(0); $('#accel-x-min').text(0); $('#accel-x-avg').text(0); $('#accel-x-var').text(0);
    $('#accel-y-max').text(0); $('#accel-y-min').text(0); $('#accel-y-avg').text(0); $('#accel-y-var').text(0);
    $('#accel-z-max').text(0); $('#accel-z-min').text(0); $('#accel-z-avg').text(0); $('#accel-z-var').text(0);
    $('#accel-total-max').text(0); $('#accel-total-min').text(0); $('#accel-total-avg').text(0); $('#accel-total-var').text(0);
    console.log("UIとバッファをリセットしました。");
}


function calculateStatistics(dataBuffer) {
    if (dataBuffer.length === 0) {
        return { max: 0, min: 0, avg: 0, var: 0 };
    }

    const max = Math.max(...dataBuffer);
    const min = Math.min(...dataBuffer);
    const sum = dataBuffer.reduce((a, b) => a + b, 0);
    const avg = sum / dataBuffer.length;

    // 分散を計算（標本分散 - NumPyのddof=1に相当）
    // まず squaredDifferences を計算
    const squaredDifferences = dataBuffer.map(value => Math.pow(value - avg, 2));
    const variance = dataBuffer.length > 1 ? squaredDifferences.reduce((a, b) => a + b, 0) / (dataBuffer.length - 1) : 0;
    
    return {
        max: max.toFixed(3),
        min: min.toFixed(3),
        avg: avg.toFixed(3),
        var: variance.toFixed(3)
    };
}


function handleAcceleration(ev){
    const currentX = ev.acceleration.x;
    const currentY = ev.acceleration.y;
    const currentZ = ev.acceleration.z;

    $('#accel-x').text( currentX.toFixed(3) );
    $('#accel-y').text( currentY.toFixed(3) );
    $('#accel-z').text( currentZ.toFixed(3) );

    const totalAccel = Math.sqrt(
        Math.pow(currentX, 2) +
        Math.pow(currentY, 2) +
        Math.pow(currentZ, 2)
    );
    $('#accel-total').text(totalAccel.toFixed(3));

    accelXBuffer.push(currentX);
    accelYBuffer.push(currentY);
    accelZBuffer.push(currentZ);
    accelTotalBuffer.push(totalAccel);

    if (accelXBuffer.length > ACCEL_BUFFER_SIZE) accelXBuffer.shift();
    if (accelYBuffer.length > ACCEL_BUFFER_SIZE) accelYBuffer.shift();
    if (accelZBuffer.length > ACCEL_BUFFER_SIZE) accelZBuffer.shift();
    if (accelTotalBuffer.length > ACCEL_BUFFER_SIZE) accelTotalBuffer.shift();

    const statsX = calculateStatistics(accelXBuffer);
    $('#accel-x-max').text(statsX.max);
    $('#accel-x-min').text(statsX.min);
    $('#accel-x-avg').text(statsX.avg);
    $('#accel-x-var').text(statsX.var);

    const statsY = calculateStatistics(accelYBuffer);
    $('#accel-y-max').text(statsY.max);
    $('#accel-y-min').text(statsY.min);
    $('#accel-y-avg').text(statsY.avg);
    $('#accel-y-var').text(statsY.var);

    const statsZ = calculateStatistics(accelZBuffer);
    $('#accel-z-max').text(statsZ.max);
    $('#accel-z-min').text(statsZ.min);
    $('#accel-z-avg').text(statsZ.avg);
    $('#accel-z-var').text(statsZ.var);

    const statsTotal = calculateStatistics(accelTotalBuffer);
    $('#accel-total-max').text(statsTotal.max);
    $('#accel-total-min').text(statsTotal.min);
    $('#accel-total-avg').text(statsTotal.avg);
    $('#accel-total-var').text(statsTotal.var);

    let classificationResult = "Waiting for data...";

    if (accelTotalBuffer.length === ACCEL_BUFFER_SIZE) {
        const current_x_avg = parseFloat(statsX.avg);
        const current_y_avg = parseFloat(statsY.avg);
        const current_z_avg = parseFloat(statsZ.avg);
        const current_total_accel_avg = parseFloat(statsTotal.avg);
        const current_total_accel_var = parseFloat(statsTotal.var);
        const current_x_var = parseFloat(statsX.var);
        const current_y_var = parseFloat(statsY.var);
        const current_z_var = parseFloat(statsZ.var);


        // --- 分類ロジックの調整 ---
        // Pythonの決定木の可視化結果を参考に、より正確な分岐を試みます。
        // 例えば、Pythonの決定木が `total_accel_var <= 0.2` で分岐し、
        // その後 `y_avg <= 0.3` で分岐している、といった情報を活用します。

        // standing (静止): total_accelの平均が低く、かつ分散も非常に低い
        // Pythonの混同行列でstandingは完璧だったので、この条件は維持しつつ強化。
        if (current_total_accel_avg < 0.98 && current_total_accel_var < 0.05) { // 閾値を少し厳しく調整
            classificationResult = "standing";
        }
        // jumping (ジャンプ): total_accelの分散が非常に大きい、または平均が非常に大きい
        // walkingと混同しやすいので、分散の閾値をより高くする、または他の特徴も組み合わせる
        else if (current_total_accel_var > 0.6 || // 分散が非常に高い場合
                 current_total_accel_avg > 2.0 ) { // 平均加速度も非常に高い場合
            classificationResult = "jumping";
        }
        // walking (歩行): standingよりは動きがあり、jumpingよりは激しくない
        // total_accelの平均が中程度で、分散も中程度
        // ここが一番トリッキーな部分。jumpingと重ならないように調整。
        else if (current_total_accel_avg >= 0.98 && current_total_accel_avg < 2.0 && // total_accel平均がstandingとjumpingの間
                 current_total_accel_var >= 0.05 && current_total_accel_var < 0.6) { // total_accel分散もstandingとjumpingの間
            classificationResult = "walking";
        }
        else {
            classificationResult = "unknown (adjust rules)";
        }
        // --- 分類ロジックの調整ここまで ---
    }
    $('#classification-result').text(classificationResult);

    var e_time = new Date();
    const csv_line = e_time.getTime() + "," +
                     "acc ," +
                     currentX.toFixed(3) + "," +
                     currentY.toFixed(3) + "," +
                     currentZ.toFixed(3) + "," +
                     totalAccel.toFixed(3) + "," +
                     classificationResult + "\n";
    $('#acc-csv').append(csv_line);
}

function downloadCSV(filename, elementId) {
    const csvContent = document.getElementById(elementId).value;
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

    const link = document.createElement("a");
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

</script>
---
<br>
<h1>レポート</h1>
<p><b>氏名:</b> </p>
<p><b>学部:</b> </p>
<p><b>学年:</b> </p>
<p><b>学籍番号:</b> </p>
<p><b>CNSメールアドレス:</b> </p>

<h2>収集した行動データ</h2>
    <p><b>選定した理由:</b> </p>
    <p><b>収集についての詳細:</b> </p>
    <p><b>工夫した点・困難だった点:</b> </p>

<h2>特徴量</h2>
    <p><b>選定した理由:</b> </p>
    <p><b>追加した特徴量について:</b> </p>
    <p><b>工夫した点・困難だった点:</b> </p>

<h2>機械学習モデル</h2>
    <p><b>採用したアルゴリズムや学習結果の詳細:</b> </p>
    <p><b>工夫した点・困難だった点:</b> </p>

<h2>実機に移植しての性能評価</h2>
    <p><b>評価尺度について:</b> </p>
    <p><b>評価結果:</b> </p>
    <p><b>工夫した点・困難だった点:</b> </p>

</body>
</html>
